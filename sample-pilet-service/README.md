[![Piral Logo](https://github.com/smapiot/piral/raw/master/docs/assets/logo.png)](https://piral.io)

# [Sample Pilet Feed](https://piral.io) &middot; [![Build Status](https://smapiot.visualstudio.com/piral/_apis/build/status/smapiot.sample-pilet-service?branchName=master)](https://smapiot.visualstudio.com/piral/_build/latest?definitionId=14&branchName=master) [![GitHub License](https://img.shields.io/badge/license-MIT-blue.svg)](https://github.com/smapiot/piral/blob/master/LICENSE) [![GitHub Tag](https://img.shields.io/github/tag/smapiot/piral.svg)](https://github.com/smapiot/piral/releases) [![Gitter Chat](https://badges.gitter.im/gitterHQ/gitter.png)](https://gitter.im/piral-io/community)

A simple Node.js sample pilet feed service for use with Piral.

## Getting Started

For running this sample locally all you need to do is running:

```sh
npm i && npm start
```

**Remark**: This sample requires Node.js and NPM. The used port is `9000`, which could be re-configured easily (e.g., via an environment variable `PORT`).

## Auth Keys

For publishing a Pilet a handful premade keys have been added (file: `src/auth/keys.ts`):

```plain
df133a512569cbc85f69788d1b7ff5a909f6bcfe1c9a2794283a2fc35175882c
da91e6a8aeee998b7d6b0701486e4909d2ee14fbcc0af5de601c1d09982141d5
f94fa7067e0299679af2b1dda6f1835cd7ed03a43c104446954b11ec7b1509d0
edf8c9275873ca743394b3367e67149d6fda5306b577113fbf1ff4f191de69e4
ad647bdc23b7437b8fa8f27c3e2d3f70fbb493c53e9160e07d37a98df333b188
```

Either change the file when using this service in any non-local infrastructure or set the environment variable `PILET_API_KEYS` with comma separated values (e.g., `A,B,C` uses three keys `A`, `B`, and `C` instead).

## Pilet Database

For this simple sample everything is kept in memory. If you want to change this behavior to store the pilets also in a database / some storage you will need to modify the `src/db/index.ts` file.

**Remark**: The file has been prepared in such a sense that all exposed functions already return promises.

## Reported URL

For the pilets the reported URL is `http://localhost/...` unless changed via `src/constants.ts`. For simplicity, a resolution algorithm based on standard environment variables is already active.

| Variable               | Meaning                                                                         |
|------------------------|---------------------------------------------------------------------------------|
| WEBSITE_HOSTNAME       | The name of the host, e.g., `localhost`                                         |
| PORT                   | The port, otherwise falling back to 9000                                        |
| HTTPS                  | Is HTTPS active, otherwise falling back to HTTP                                 |
| HTTP_X_FORWARDED_PROTO | The used protocol (e.g., `http`), otherwise falling back to the `HTTPS` setting |

## Usage via NPM

Alternatively, if you want to use the service only locally to play around you can also install and run the package via NPM:

```sh
npx sample-pilet-service
```

You could also install it globally:

```sh
npm i sample-pilet-service -g
```

This will enable a new command `sample-pilet-service` to be invoked on the command line shell.

## License

Piral is released using the MIT license. For more information see the [license file](./LICENSE).


RUN SAMPLE SERVICE USING DOCKER IMAGE -> docker run -d -p 9008:9001 pardeepbhasin/sample-pilet-service:56


## Create teamcity pipeline using below step:

1.) Install teamcity on cloud or on your local window system.
2.) Create project inside teamcity.
3.) While creating project pass your repository name with creds or using token. Token will generate from git repo.
4.) Create below build steps to create basic CI pipe line.

Step 1 - 
a.) In this step runner type will be Power shell.
b.) step name GitVersion execute.
c.) Pass your script file like teamcity/gitversion.ps1. This file is available in project folder called teamcity. If you find any
path issue called powershell script is not available. Then copy the teamcity folder from your project to build agent under below path.
C:\TeamCity\buildAgent\work\e16b000ac159bcc9. In your case under work directory folder called e16b000ac159bcc9 will be different one.
d.) Click on save button

Step2 -

a.) Runner type Docker
b.) Specify path to file. Example - sample-pilet-service/Dockerfile
c.) Image name: tag pardeepbhasin/sample-pilet-service:%build.counter%
d.) Clic on save button

Step 3 - 

a.) Runner will be CommandLine
b.) Step name DockerPush and run as Custom script
c.) Inside Custom script section add below command to push the image to repo

docker push pardeepbhasin/sample-pilet-service:%build.counter%

We can replace build.counter with build.number to create the build tag with full semantic version generated by Gitversion


BUILD FEATURES:

Step1 - Pull Request is default step

Step2 - Commit status publisher -  This status publish the status of build to github once build succes on
teamcity.
a.) Publisher is GitHub.
b.) GitHub url (https://api.github.com) is by default picked in case of github
c.) Choose Authentication type as Access token then pass the access token generated from github

Step3 - Docker Support

1.) Inside popup click on Project connection link then add connection.

a.) Display name as Docker registry
b.) Registry address as https://docker.io or it can be private nexus repo
c.) Add username and password and click on test connection. If got success then click save.

Go to Docker support build feature click on Add registry connection and then choose repo and save.